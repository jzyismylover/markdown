<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mr.Jiang-技术博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="">
    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?2675818a983a3131404cee835018f016";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
      </script>
    <meta name="description" content="学习&amp;工作-技术积累">
    
    <link rel="preload" href="/markdown/assets/css/0.styles.5474aed4.css" as="style"><link rel="preload" href="/markdown/assets/js/app.085aa012.js" as="script"><link rel="preload" href="/markdown/assets/js/2.773263cd.js" as="script"><link rel="preload" href="/markdown/assets/js/73.cc81c046.js" as="script"><link rel="prefetch" href="/markdown/assets/js/1.50bc9635.js"><link rel="prefetch" href="/markdown/assets/js/10.121e7e8f.js"><link rel="prefetch" href="/markdown/assets/js/11.5205ffab.js"><link rel="prefetch" href="/markdown/assets/js/12.fef29d74.js"><link rel="prefetch" href="/markdown/assets/js/13.b581db50.js"><link rel="prefetch" href="/markdown/assets/js/14.07202c28.js"><link rel="prefetch" href="/markdown/assets/js/15.9aedb95a.js"><link rel="prefetch" href="/markdown/assets/js/16.dd97e264.js"><link rel="prefetch" href="/markdown/assets/js/17.8eb943fb.js"><link rel="prefetch" href="/markdown/assets/js/18.942cde78.js"><link rel="prefetch" href="/markdown/assets/js/19.44710683.js"><link rel="prefetch" href="/markdown/assets/js/20.22d46747.js"><link rel="prefetch" href="/markdown/assets/js/21.aa8b4011.js"><link rel="prefetch" href="/markdown/assets/js/22.b40024cc.js"><link rel="prefetch" href="/markdown/assets/js/23.ace5d346.js"><link rel="prefetch" href="/markdown/assets/js/24.2405d60a.js"><link rel="prefetch" href="/markdown/assets/js/25.c08a85e2.js"><link rel="prefetch" href="/markdown/assets/js/26.c4c5f267.js"><link rel="prefetch" href="/markdown/assets/js/27.b91e5849.js"><link rel="prefetch" href="/markdown/assets/js/28.b80c3633.js"><link rel="prefetch" href="/markdown/assets/js/29.594ec447.js"><link rel="prefetch" href="/markdown/assets/js/3.9d4223ad.js"><link rel="prefetch" href="/markdown/assets/js/30.324e278d.js"><link rel="prefetch" href="/markdown/assets/js/31.43dc2191.js"><link rel="prefetch" href="/markdown/assets/js/32.3fb01abd.js"><link rel="prefetch" href="/markdown/assets/js/33.5a2693b9.js"><link rel="prefetch" href="/markdown/assets/js/34.637d4661.js"><link rel="prefetch" href="/markdown/assets/js/35.eccfebaa.js"><link rel="prefetch" href="/markdown/assets/js/36.c13df5f5.js"><link rel="prefetch" href="/markdown/assets/js/37.9890e89c.js"><link rel="prefetch" href="/markdown/assets/js/38.b33827f2.js"><link rel="prefetch" href="/markdown/assets/js/39.3a1ace37.js"><link rel="prefetch" href="/markdown/assets/js/4.27d6f5b1.js"><link rel="prefetch" href="/markdown/assets/js/40.4396d4c2.js"><link rel="prefetch" href="/markdown/assets/js/41.afe775e0.js"><link rel="prefetch" href="/markdown/assets/js/42.19b2951c.js"><link rel="prefetch" href="/markdown/assets/js/43.7c3256ea.js"><link rel="prefetch" href="/markdown/assets/js/44.7da308e4.js"><link rel="prefetch" href="/markdown/assets/js/45.89b2fd21.js"><link rel="prefetch" href="/markdown/assets/js/46.e817e45d.js"><link rel="prefetch" href="/markdown/assets/js/47.c56ee626.js"><link rel="prefetch" href="/markdown/assets/js/48.59541039.js"><link rel="prefetch" href="/markdown/assets/js/49.bc7ad96a.js"><link rel="prefetch" href="/markdown/assets/js/5.2637f2cc.js"><link rel="prefetch" href="/markdown/assets/js/50.9d0dc446.js"><link rel="prefetch" href="/markdown/assets/js/51.4d949834.js"><link rel="prefetch" href="/markdown/assets/js/52.90aa4f80.js"><link rel="prefetch" href="/markdown/assets/js/53.67b77129.js"><link rel="prefetch" href="/markdown/assets/js/54.3535db37.js"><link rel="prefetch" href="/markdown/assets/js/55.9efbe9e5.js"><link rel="prefetch" href="/markdown/assets/js/56.e8aa37ba.js"><link rel="prefetch" href="/markdown/assets/js/57.af66ff8f.js"><link rel="prefetch" href="/markdown/assets/js/58.0415674f.js"><link rel="prefetch" href="/markdown/assets/js/59.b09373ca.js"><link rel="prefetch" href="/markdown/assets/js/6.61bacfb8.js"><link rel="prefetch" href="/markdown/assets/js/60.d07cb515.js"><link rel="prefetch" href="/markdown/assets/js/61.ec2b2da7.js"><link rel="prefetch" href="/markdown/assets/js/62.44a5a0b8.js"><link rel="prefetch" href="/markdown/assets/js/63.09e39adc.js"><link rel="prefetch" href="/markdown/assets/js/64.b9ee085d.js"><link rel="prefetch" href="/markdown/assets/js/65.026450b0.js"><link rel="prefetch" href="/markdown/assets/js/66.a3571972.js"><link rel="prefetch" href="/markdown/assets/js/67.5a8616c4.js"><link rel="prefetch" href="/markdown/assets/js/68.6fdda787.js"><link rel="prefetch" href="/markdown/assets/js/69.691ff5d7.js"><link rel="prefetch" href="/markdown/assets/js/7.32a4bd87.js"><link rel="prefetch" href="/markdown/assets/js/70.b401009e.js"><link rel="prefetch" href="/markdown/assets/js/71.6b3bcefe.js"><link rel="prefetch" href="/markdown/assets/js/72.dcd8145e.js"><link rel="prefetch" href="/markdown/assets/js/74.856f40f0.js"><link rel="prefetch" href="/markdown/assets/js/75.746590de.js"><link rel="prefetch" href="/markdown/assets/js/76.8ddba5b5.js"><link rel="prefetch" href="/markdown/assets/js/77.16644476.js"><link rel="prefetch" href="/markdown/assets/js/78.e89fc885.js"><link rel="prefetch" href="/markdown/assets/js/79.1193b665.js"><link rel="prefetch" href="/markdown/assets/js/80.9475cd89.js"><link rel="prefetch" href="/markdown/assets/js/81.8d99d275.js"><link rel="prefetch" href="/markdown/assets/js/82.80eb3e2f.js"><link rel="prefetch" href="/markdown/assets/js/83.fe14141e.js"><link rel="prefetch" href="/markdown/assets/js/84.9647a2db.js"><link rel="prefetch" href="/markdown/assets/js/85.c7258f01.js"><link rel="prefetch" href="/markdown/assets/js/86.1a5782f4.js"><link rel="prefetch" href="/markdown/assets/js/87.e7354607.js"><link rel="prefetch" href="/markdown/assets/js/vendors~docsearch.54f2532f.js">
    <link rel="stylesheet" href="/markdown/assets/css/0.styles.5474aed4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/markdown/" class="home-link router-link-active"><img src="/markdown/logo.png" alt="Mr.Jiang-技术博客" class="logo"> <span class="site-name can-hide">Mr.Jiang-技术博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/jzyismylover/ubuntu-markdown" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/jzyismylover/ubuntu-markdown" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/markdown/indicator-app/#用户信息" class="sidebar-link">用户信息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/markdown/indicator-app/#jwt" class="sidebar-link">jwt</a></li><li class="sidebar-sub-header"><a href="/markdown/indicator-app/#邮箱认证" class="sidebar-link">邮箱认证</a></li><li class="sidebar-sub-header"><a href="/markdown/indicator-app/#操作历史" class="sidebar-link">操作历史</a></li></ul></li><li><a href="/markdown/indicator-app/#指标提取" class="sidebar-link">指标提取</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/markdown/indicator-app/#celery" class="sidebar-link">celery</a></li></ul></li><li><a href="/markdown/indicator-app/#文本处理" class="sidebar-link">文本处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/markdown/indicator-app/#西方语种文本" class="sidebar-link">西方语种文本</a></li><li class="sidebar-sub-header"><a href="/markdown/indicator-app/#小语种文本" class="sidebar-link">小语种文本</a></li><li class="sidebar-sub-header"><a href="/markdown/indicator-app/#中文" class="sidebar-link">中文</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="content"><div class="content-wrapper" style="width:100%"><div class="theme-default-content custom-content content__default"><blockquote><p>计量指标提取工具后端应用设计的一些记录</p></blockquote> <p><img alt="无标题-2023-06-17-1439" data-src="/markdown/home/jzy/Documents/markdown/indicator-app/indicator-app.assets/01.png" loading="lazy" class="lazy"></p> <h2 id="用户信息"><a href="#用户信息" class="header-anchor">#</a> 用户信息</h2> <p>从用户信息来看总体其实也没有用到什么新鲜点，鉴权依旧是使用 <code>jwt</code>，可能之前没有接触的是 <code>邮箱认证</code>，具体的逻辑就是当用户注册的时候发送一个 <code>六位数</code>验证码。</p> <h3 id="jwt"><a href="#jwt" class="header-anchor">#</a> jwt</h3> <img src="/home/jzy/Documents/markdown/indicator-app/indicator-app.assets/02.png" style="display:block;margin:auto;"> <p>对于业务内需要保护的 <code>api</code> 基本都需遵循这套流程，即使用前都需要校验 <code>token</code>。当然如何去鉴定的问题就是 <code>jwt</code> 包所处理的事情。</p> <ul><li>Q：实际在生成 <code>token</code> 时，我之前还一直纳闷就是为什么每次生成的 <code>token</code> 都不一样（即使我传入了相同的 <code>user_id</code>）。其实是在注入 <code>payload</code> 的时候 <code>exp</code> 每次都不一样</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">create_token</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'user_id'</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
        <span class="token string">'exp'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment"># 时间变化导致每次生成token签名不一样</span>
    <span class="token punctuation">}</span>
    token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>payload<span class="token operator">=</span>payload<span class="token punctuation">,</span> key<span class="token operator">=</span>SALT<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> token
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="邮箱认证"><a href="#邮箱认证" class="header-anchor">#</a> 邮箱认证</h3> <p>验证逻辑</p> <ol><li>基于 <code>uuid.uuid4()</code> 截取 6 位生成 <code>hash</code></li> <li>发送出去同时将 <code>hash</code> 存储在 <code>redis</code> 中，当然也必须对验证码设定一个过期期限，因此实际存进去的是一个 <code>dict</code>，包含生成的时间以及具体 <code>hash</code></li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code>mark_dyn_data<span class="token punctuation">(</span>email<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'update_time'</span><span class="token punctuation">:</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'code'</span><span class="token punctuation">:</span> captcha<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li>认证时根据传入邮箱从 <code>redis</code> 获取 <code>hash</code> 判断传入与当前值是否相同</li></ol> <h3 id="操作历史"><a href="#操作历史" class="header-anchor">#</a> 操作历史</h3> <p>在文本语种识别模块需要记录下用户输入文本，因此需要新建一个 <code>history</code> 表存储. 逻辑不难唯一需要注意的是在获取 用户<code>history</code>必须基于 <code>user_id</code> 进行获取。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_history_rows</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Session<span class="token punctuation">(</span>engine<span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        stmt <span class="token operator">=</span> select<span class="token punctuation">(</span>History<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>History<span class="token punctuation">.</span>user_id <span class="token operator">==</span> user_id<span class="token punctuation">)</span>
        rows <span class="token operator">=</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        rows <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        histories <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 实际每个item都是(..., )元组</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> rows<span class="token punctuation">:</span>
            item <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token comment"># 每个表的字段</span>
            <span class="token comment"># id</span>
            <span class="token comment"># lg_text</span>
            <span class="token comment"># lg_type</span>
            <span class="token comment"># user_id 标明是哪一个用户创建</span>
            histories<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                <span class="token punctuation">{</span>
                    <span class="token string">'id'</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
                    <span class="token string">'lg_text'</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
                    <span class="token string">'lg_type'</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
    <span class="token keyword">return</span> histories
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="指标提取"><a href="#指标提取" class="header-anchor">#</a> 指标提取</h2> <h3 id="celery"><a href="#celery" class="header-anchor">#</a> celery</h3> <blockquote><p>python 异步实现，在程序中主要体现是不阻塞应用程序执行将任务交给后台 <code>worker</code> 进程处理</p></blockquote> <p>实际使用的难点在数据序列化问题： 对于 <code>File</code> 无法找到一个比较好的序列方式。当尝试把 <code>File</code> 内容读取为二进制再放入序列化时会发现报错，因为 <code>celery</code> 默认的序列化方式为 <code>json</code>，<code>json</code> 不支持序列化二进制内容。因此最后采取的策略就是通过传入 <code>二进制 hash</code> 的方式</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 传入</span>
<span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 读取</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>尝试这个方法前，其实也想使用 <code>decode</code> / <code>encode</code> 的方式基于 <code>unicode</code></p> <ul><li>decode() 方法用于将 bytes 类型的二进制数据转换为 str 类型，这个过程也称为“解码”</li> <li>encode() 方法为字符串类型（str）提供的方法，用于将 str 类型转换成 bytes 类型，这个过程也称为“编码”</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用的时候会发现针对英文或者中文这样的编码解码过程没有问题，但是对于一些小众语种文本可能就没办法正常处理（小语种文本），解码生成的 str 无法编码成功，生成 <code>File</code> 时出现乱码。</p> <blockquote><p>回到 celery 的知识，celery 主要由 broker、backend、worker 组成</p></blockquote> <ul><li><code>broker</code>： 任务中心，存储任务列表</li> <li><code>backend</code>： 结果中心，存储任务执行结果</li> <li><code>worker</code>： 具体执行任务的进程或者线程</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>celery <span class="token operator">=</span> Celery<span class="token punctuation">(</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'CELERY_NAME'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    broker<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'CELERY_BROKER_URL'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    backend<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'CELERY_RESULT_BACKEND'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment"># result_extended=True</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="文本处理"><a href="#文本处理" class="header-anchor">#</a> 文本处理</h2> <blockquote><p>该模块也是花的时间最多的地方，不是也别熟悉 <code>nlp</code> 中文本分句以及文本分词模块</p></blockquote> <h3 id="西方语种文本"><a href="#西方语种文本" class="header-anchor">#</a> 西方语种文本</h3> <p>可基于 <code>nltk</code> 处理，分句大多数基于 <code>['.', ',', '!', '?', '\n']</code> 切割。但需要注意的是有些缩写像 <code>Mr.sun</code> 这种是不能切割，因此需要去定义一些规则去避免对 <code>.</code> 的完全切割。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>EN_SPECIAL_WORDS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">,</span> <span class="token string">'!'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">]</span>
<span class="token keyword">class</span> <span class="token class-name">ENUtils</span><span class="token punctuation">(</span>BaseUtils<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get_sentences</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>
        tokenizer <span class="token operator">=</span> nltk<span class="token punctuation">.</span>data<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'tokenizers/punkt/english.pickle'</span><span class="token punctuation">)</span>
        sentences <span class="token operator">=</span> tokenizer<span class="token punctuation">.</span>tokenize<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        <span class="token keyword">return</span> sentences

    <span class="token keyword">def</span> <span class="token function">get_words</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sentences<span class="token punctuation">)</span><span class="token punctuation">:</span>
        all_words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> sentence <span class="token keyword">in</span> sentences<span class="token punctuation">:</span>
            words <span class="token operator">=</span> word_tokenize<span class="token punctuation">(</span>sentence<span class="token punctuation">,</span> preserve_line<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            filtered_words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> word <span class="token keyword">in</span> words<span class="token punctuation">:</span>
                <span class="token keyword">if</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'[a-zA-Z0-9]'</span><span class="token punctuation">,</span> word<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    <span class="token keyword">pass</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">for</span> _ <span class="token keyword">in</span> EN_SPECIAL_WORDS<span class="token punctuation">:</span>
                        word <span class="token operator">=</span> word<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token comment"># 标点去除</span>
                    filtered_words<span class="token punctuation">.</span>append<span class="token punctuation">(</span>word<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            all_words<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>filtered_words<span class="token punctuation">)</span>
        <span class="token keyword">return</span> all_words
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="小语种文本"><a href="#小语种文本" class="header-anchor">#</a> 小语种文本</h3> <blockquote><p>对于小语种的文本处理，分词的话更多是基于网上一些深度学习框架（基于多语种训练的 <code>hanlp</code>）。分句如果不是特别在于追求高精度的话可以通过自定义分割符进行切割</p></blockquote> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 缅甸语</span>
<span class="token keyword">class</span> <span class="token class-name">BUUtils</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get_sentences</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        ။(taa gun)：用于分割句子。相当于英文中的句号。
        ၊(nya yit)：用于分割短语或词组。相当于英文中的逗号。
        ၍(lae gyi)：用于表示省略或缩写。相当于英文中的省略号或缩写号。
        &quot;&quot;&quot;</span>
        sentence_breaks <span class="token operator">=</span> <span class="token string">r'([။၊၍?!,])'</span>
        text <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        <span class="token comment"># 保留原符号</span>
        text <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>sentence_breaks<span class="token punctuation">,</span> <span class="token string">'\g&lt;1&gt;&lt;space break&gt;'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>
        sentences <span class="token operator">=</span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'&lt;space break&gt;'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>
        <span class="token keyword">return</span> sentences
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="中文"><a href="#中文" class="header-anchor">#</a> 中文</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">ZHUtils</span><span class="token punctuation">(</span>BaseUtils<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get_sentences</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 考虑对 ...... 的处理</span>
        p <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'(“.*?”)|(.*?[。！？…]{1,2}”?)'</span><span class="token punctuation">)</span>
        sentences <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> p<span class="token punctuation">.</span>finditer<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
            temp <span class="token operator">=</span> <span class="token string">''</span>
            start <span class="token operator">=</span> i<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
            end <span class="token operator">=</span> i<span class="token punctuation">.</span>end<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">:</span>
                temp <span class="token operator">+=</span> text<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
            <span class="token keyword">if</span> temp <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">:</span>
                sentences<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp<span class="token punctuation">)</span>

        <span class="token keyword">return</span> sentences

    <span class="token keyword">def</span> <span class="token function">get_words</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sentences<span class="token punctuation">,</span> is_cut_word<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">:</span>
        words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> sentence <span class="token keyword">in</span> sentences<span class="token punctuation">:</span>
            <span class="token keyword">if</span> is_cut_word <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
                words<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> convert<span class="token punctuation">(</span>sentence<span class="token punctuation">,</span> <span class="token string">'zh-cn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                words<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>
                    <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> jieba<span class="token punctuation">.</span>cut<span class="token punctuation">(</span>sentence<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> i <span class="token keyword">not</span> <span class="token keyword">in</span> SYMBOLS<span class="token punctuation">]</span>
                <span class="token punctuation">)</span>
        <span class="token keyword">return</span> words
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div></div> <footer class="page-edit page-editor"><div class="edit-link"><a href="https://github.com/jzyismylover/ubuntu-markdown/edit/docs/others/indicator-app/indicator-app.md" target="_blank" rel="noopener noreferrer">完善页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最近更新:</span> <span class="time">3/17/2024, 9:24:20 AM</span></div></footer> <!----></div> <div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:86vh"><div style="font-weight:bold;"></div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/markdown/indicator-app/#用户信息" class="toc-sidebar-link">用户信息</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/markdown/indicator-app/#jwt" class="toc-sidebar-link">jwt</a></li><li class="toc-sidebar-sub-header"><a href="/markdown/indicator-app/#邮箱认证" class="toc-sidebar-link">邮箱认证</a></li><li class="toc-sidebar-sub-header"><a href="/markdown/indicator-app/#操作历史" class="toc-sidebar-link">操作历史</a></li></ul></li><li><a href="/markdown/indicator-app/#指标提取" class="toc-sidebar-link">指标提取</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/markdown/indicator-app/#celery" class="toc-sidebar-link">celery</a></li></ul></li><li><a href="/markdown/indicator-app/#文本处理" class="toc-sidebar-link">文本处理</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/markdown/indicator-app/#西方语种文本" class="toc-sidebar-link">西方语种文本</a></li><li class="toc-sidebar-sub-header"><a href="/markdown/indicator-app/#小语种文本" class="toc-sidebar-link">小语种文本</a></li><li class="toc-sidebar-sub-header"><a href="/markdown/indicator-app/#中文" class="toc-sidebar-link">中文</a></li></ul></li></ul></div></div></div></div></div>  <div></div></main> <aside class="page-sidebar"> <div class="page-side-toolbar"></div>  </aside></div><div class="global-ui"><!----></div></div>
    <script src="/markdown/assets/js/app.085aa012.js" defer></script><script src="/markdown/assets/js/2.773263cd.js" defer></script><script src="/markdown/assets/js/73.cc81c046.js" defer></script>
  </body>
</html>
