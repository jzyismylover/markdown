<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端错误捕获 | Mr.Jiang-技术博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="">
    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?2675818a983a3131404cee835018f016";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
      </script>
    <meta name="description" content="学习&amp;工作-技术积累">
    
    <link rel="preload" href="/markdown/assets/css/0.styles.5474aed4.css" as="style"><link rel="preload" href="/markdown/assets/js/app.085aa012.js" as="script"><link rel="preload" href="/markdown/assets/js/2.773263cd.js" as="script"><link rel="preload" href="/markdown/assets/js/42.19b2951c.js" as="script"><link rel="prefetch" href="/markdown/assets/js/1.50bc9635.js"><link rel="prefetch" href="/markdown/assets/js/10.121e7e8f.js"><link rel="prefetch" href="/markdown/assets/js/11.5205ffab.js"><link rel="prefetch" href="/markdown/assets/js/12.fef29d74.js"><link rel="prefetch" href="/markdown/assets/js/13.b581db50.js"><link rel="prefetch" href="/markdown/assets/js/14.07202c28.js"><link rel="prefetch" href="/markdown/assets/js/15.9aedb95a.js"><link rel="prefetch" href="/markdown/assets/js/16.dd97e264.js"><link rel="prefetch" href="/markdown/assets/js/17.8eb943fb.js"><link rel="prefetch" href="/markdown/assets/js/18.942cde78.js"><link rel="prefetch" href="/markdown/assets/js/19.44710683.js"><link rel="prefetch" href="/markdown/assets/js/20.22d46747.js"><link rel="prefetch" href="/markdown/assets/js/21.aa8b4011.js"><link rel="prefetch" href="/markdown/assets/js/22.b40024cc.js"><link rel="prefetch" href="/markdown/assets/js/23.ace5d346.js"><link rel="prefetch" href="/markdown/assets/js/24.2405d60a.js"><link rel="prefetch" href="/markdown/assets/js/25.c08a85e2.js"><link rel="prefetch" href="/markdown/assets/js/26.c4c5f267.js"><link rel="prefetch" href="/markdown/assets/js/27.b91e5849.js"><link rel="prefetch" href="/markdown/assets/js/28.b80c3633.js"><link rel="prefetch" href="/markdown/assets/js/29.594ec447.js"><link rel="prefetch" href="/markdown/assets/js/3.9d4223ad.js"><link rel="prefetch" href="/markdown/assets/js/30.324e278d.js"><link rel="prefetch" href="/markdown/assets/js/31.43dc2191.js"><link rel="prefetch" href="/markdown/assets/js/32.3fb01abd.js"><link rel="prefetch" href="/markdown/assets/js/33.5a2693b9.js"><link rel="prefetch" href="/markdown/assets/js/34.637d4661.js"><link rel="prefetch" href="/markdown/assets/js/35.eccfebaa.js"><link rel="prefetch" href="/markdown/assets/js/36.c13df5f5.js"><link rel="prefetch" href="/markdown/assets/js/37.9890e89c.js"><link rel="prefetch" href="/markdown/assets/js/38.b33827f2.js"><link rel="prefetch" href="/markdown/assets/js/39.3a1ace37.js"><link rel="prefetch" href="/markdown/assets/js/4.27d6f5b1.js"><link rel="prefetch" href="/markdown/assets/js/40.4396d4c2.js"><link rel="prefetch" href="/markdown/assets/js/41.afe775e0.js"><link rel="prefetch" href="/markdown/assets/js/43.7c3256ea.js"><link rel="prefetch" href="/markdown/assets/js/44.7da308e4.js"><link rel="prefetch" href="/markdown/assets/js/45.89b2fd21.js"><link rel="prefetch" href="/markdown/assets/js/46.e817e45d.js"><link rel="prefetch" href="/markdown/assets/js/47.c56ee626.js"><link rel="prefetch" href="/markdown/assets/js/48.59541039.js"><link rel="prefetch" href="/markdown/assets/js/49.bc7ad96a.js"><link rel="prefetch" href="/markdown/assets/js/5.2637f2cc.js"><link rel="prefetch" href="/markdown/assets/js/50.9d0dc446.js"><link rel="prefetch" href="/markdown/assets/js/51.4d949834.js"><link rel="prefetch" href="/markdown/assets/js/52.90aa4f80.js"><link rel="prefetch" href="/markdown/assets/js/53.67b77129.js"><link rel="prefetch" href="/markdown/assets/js/54.3535db37.js"><link rel="prefetch" href="/markdown/assets/js/55.9efbe9e5.js"><link rel="prefetch" href="/markdown/assets/js/56.e8aa37ba.js"><link rel="prefetch" href="/markdown/assets/js/57.af66ff8f.js"><link rel="prefetch" href="/markdown/assets/js/58.0415674f.js"><link rel="prefetch" href="/markdown/assets/js/59.b09373ca.js"><link rel="prefetch" href="/markdown/assets/js/6.61bacfb8.js"><link rel="prefetch" href="/markdown/assets/js/60.d07cb515.js"><link rel="prefetch" href="/markdown/assets/js/61.ec2b2da7.js"><link rel="prefetch" href="/markdown/assets/js/62.44a5a0b8.js"><link rel="prefetch" href="/markdown/assets/js/63.09e39adc.js"><link rel="prefetch" href="/markdown/assets/js/64.b9ee085d.js"><link rel="prefetch" href="/markdown/assets/js/65.026450b0.js"><link rel="prefetch" href="/markdown/assets/js/66.a3571972.js"><link rel="prefetch" href="/markdown/assets/js/67.5a8616c4.js"><link rel="prefetch" href="/markdown/assets/js/68.6fdda787.js"><link rel="prefetch" href="/markdown/assets/js/69.691ff5d7.js"><link rel="prefetch" href="/markdown/assets/js/7.32a4bd87.js"><link rel="prefetch" href="/markdown/assets/js/70.b401009e.js"><link rel="prefetch" href="/markdown/assets/js/71.6b3bcefe.js"><link rel="prefetch" href="/markdown/assets/js/72.dcd8145e.js"><link rel="prefetch" href="/markdown/assets/js/73.cc81c046.js"><link rel="prefetch" href="/markdown/assets/js/74.856f40f0.js"><link rel="prefetch" href="/markdown/assets/js/75.746590de.js"><link rel="prefetch" href="/markdown/assets/js/76.8ddba5b5.js"><link rel="prefetch" href="/markdown/assets/js/77.16644476.js"><link rel="prefetch" href="/markdown/assets/js/78.e89fc885.js"><link rel="prefetch" href="/markdown/assets/js/79.1193b665.js"><link rel="prefetch" href="/markdown/assets/js/80.9475cd89.js"><link rel="prefetch" href="/markdown/assets/js/81.8d99d275.js"><link rel="prefetch" href="/markdown/assets/js/82.80eb3e2f.js"><link rel="prefetch" href="/markdown/assets/js/83.fe14141e.js"><link rel="prefetch" href="/markdown/assets/js/84.9647a2db.js"><link rel="prefetch" href="/markdown/assets/js/85.c7258f01.js"><link rel="prefetch" href="/markdown/assets/js/86.1a5782f4.js"><link rel="prefetch" href="/markdown/assets/js/87.e7354607.js"><link rel="prefetch" href="/markdown/assets/js/vendors~docsearch.54f2532f.js">
    <link rel="stylesheet" href="/markdown/assets/css/0.styles.5474aed4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/markdown/" class="home-link router-link-active"><img src="/markdown/logo.png" alt="Mr.Jiang-技术博客" class="logo"> <span class="site-name can-hide">Mr.Jiang-技术博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/jzyismylover/ubuntu-markdown" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/jzyismylover/ubuntu-markdown" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/markdown/fronted/" class="sidebar-link">前端知识概述</a></li><li><a href="/markdown/git/" class="sidebar-link">版本控制</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/markdown/typescript/" class="sidebar-link">Typescript</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Electron</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>前端监控</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/markdown/capture/" aria-current="page" class="active sidebar-link">前端错误捕获</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/markdown/capture/#运行时错误" class="sidebar-link">运行时错误</a></li><li class="sidebar-sub-header"><a href="/markdown/capture/#静态资源错误" class="sidebar-link">静态资源错误</a></li><li class="sidebar-sub-header"><a href="/markdown/capture/#promise-错误" class="sidebar-link">Promise 错误</a></li><li class="sidebar-sub-header"><a href="/markdown/capture/#http-错误" class="sidebar-link">HTTP 错误</a></li><li class="sidebar-sub-header"><a href="/markdown/capture/#跨域脚本错误" class="sidebar-link">跨域脚本错误</a></li><li class="sidebar-sub-header"><a href="/markdown/capture/#框架内错误" class="sidebar-link">框架内错误</a></li><li class="sidebar-sub-header"><a href="/markdown/capture/#beacon" class="sidebar-link">beacon</a></li><li class="sidebar-sub-header"><a href="/markdown/capture/#image" class="sidebar-link">image</a></li><li class="sidebar-sub-header"><a href="/markdown/capture/#request" class="sidebar-link">request</a></li><li class="sidebar-sub-header"><a href="/markdown/capture/#映射过程" class="sidebar-link">映射过程</a></li></ul></li><li><a href="/markdown/performance/" class="sidebar-link">性能优化</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="content"><div class="content-wrapper" style="width:100%"><div class="theme-default-content custom-content content__default"><h1 id="前端错误捕获"><a href="#前端错误捕获" class="header-anchor">#</a> 前端错误捕获</h1> <p>前端错误监控流程：</p> <ol><li>捕获错误构造需要呈现在报表汇总中的信息</li> <li>上报构造好的错误信息</li> <li>根据错误信息结构绘制报表 UI，在 UI 中进行错误定位</li></ol> <p>以下会对上述三个流程进行分析</p> <blockquote><p><a href="https://juejin.cn/post/7100841779854835719#heading-5" target="_blank" rel="noopener noreferrer">前端错误捕获<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <ol><li>为什么要捕获错误然后进行上报？</li> <li>从前端的角度来说捕获什么内容？</li> <li>如何通过 api 进行前端错误捕获？</li></ol> <ul><li><p>第一个问题（为什么需要捕获 &amp; 上报错误）：错误是用户使用系统功能异常的反馈，在出现问题的时候我们可以通过错误快速定位问题位置</p></li> <li><p>第二个问题（需要捕获什么错误）：从宏观来分可以分为 js 报错 和 http 报错.</p> <ul><li>js 报错指的是运行时上代码段的执行错误</li> <li>http 报错指的是网络请求的报错（网站数据的展示依赖于网络响应请求返回）</li></ul></li> <li><p>第三个问题（怎么捕获错误）</p> <ul><li>window.onerror</li> <li>window.addEventListener('error')</li> <li>app.prototype.errorHandler</li> <li>window.addEventListener('unhandlerejection')</li></ul></li></ul> <blockquote><p>从微观来分类错误的类型</p></blockquote> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">enum</span> mechanismType <span class="token punctuation">{</span>
  <span class="token constant">JS</span> <span class="token operator">=</span> <span class="token string">&quot;js&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">RS</span> <span class="token operator">=</span> <span class="token string">&quot;resource&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">UJ</span> <span class="token operator">=</span> <span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">HP</span> <span class="token operator">=</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">CS</span> <span class="token operator">=</span> <span class="token string">&quot;cors&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">VUE</span> <span class="token operator">=</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="运行时错误"><a href="#运行时错误" class="header-anchor">#</a> 运行时错误</h2> <blockquote><p>运行时 <code>JS</code> 错误捕获方法：<code>window.onerror</code>、<code>window.addEvenetListener('error')</code></p></blockquote> <p>两者的区别：</p> <ol><li><code>window.onerror</code> 只能存在一个且后声明的覆盖前面声明的，<code>window.addEvenetListener('error')</code> 可以声明多个，按添加顺序触发执行</li> <li><code>window.addEvenetListener('error')</code> 能够处理静态资源错误</li> <li><code>window.addEventListener('error')</code> 在捕获阶段工作</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span>
<span class="token comment">// @return boolean</span>
<span class="token comment">// true: prevent console</span>
<span class="token comment">// false: console in the browser</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>message(<code>String</code>)：错误信息</li> <li>source(<code>String</code>)：发生错误的脚本 url</li> <li>lineno(<code>Number</code>)：发送错误的行号</li> <li>colno(<code>Number</code>)：发生错误的列号</li> <li>error(<code>Error</code>)：Error 对象</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>error( <code>ErrorEvent</code>)：错误事件对象 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ErrorEvent" target="_blank" rel="noopener noreferrer">MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>extend Event</li> <li>message(<code>String</code>)：错误信息</li> <li>filename(<code>String</code>)：发生错误的脚本 url</li> <li>lineno(<code>Number</code>)：发送错误的行号</li> <li>colno(<code>Number</code>)：发生错误的列号</li> <li>error(<code>Error</code>)：Error 对象</li></ul></li></ul> <blockquote><p>js 运行时错误类型</p></blockquote> <img src="/markdown/assets/img/image-20231108004503666.7a94894a.png" style="display:block;margin:auto;"> <p>🎲 解析运行时错误堆栈调用：可以使用开源库 <a href="https://www.npmjs.com/package/error-stack-parser/v/2.0.5" target="_blank" rel="noopener noreferrer"><code>error-stack-parser</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, 传入 <code>error</code> 对象可以帮助解析出调用堆栈以及具体错误发生的行号、列号…….。（虽然没具体深入了解源码，但是基本的实现应该如下，基于正则处理 <code>error message string</code>）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 正则表达式，用以解析堆栈split后得到的字符串</span>
<span class="token keyword">const</span> <span class="token constant">FULL_MATCH</span> <span class="token operator">=</span>
  <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*at (?:(.*?) ?\()?((?:file|https?|blob|chrome-extension|address|native|eval|webpack|&lt;anonymous&gt;|[-a-z]+:|.*bundle|\/).*?)(?::(\d+))?(?::(\d+))?\)?\s*$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">;</span>

<span class="token comment">// 限制只追溯10个堆栈</span>
<span class="token keyword">const</span> <span class="token constant">STACKTRACE_LIMIT</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token comment">// 解析每一行</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parseStackLine</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">line</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> lineMatch <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token constant">FULL_MATCH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lineMatch<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> filename <span class="token operator">=</span> lineMatch<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> functionName <span class="token operator">=</span> lineMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> lineno <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>lineMatch<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> colno <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>lineMatch<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">,</span>
    functionName<span class="token punctuation">,</span>
    lineno<span class="token punctuation">,</span>
    colno<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="静态资源错误"><a href="#静态资源错误" class="header-anchor">#</a> 静态资源错误</h2> <p>静态资源加载异常：界面上的 <code>img 图片</code>、<code>CDN 资源</code> <strong>突然失效了、打不开了</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用 <code>addEventListener</code> 捕获资源错误时，一定要将 <strong>第三个选项设为 true</strong>，因为资源错误没有冒泡，所以只能在捕获阶段捕获。同理，由于 <code>window.onerror</code> 是通过在冒泡阶段捕获错误，所以无法捕获资源错误。</p> <h2 id="promise-错误"><a href="#promise-错误" class="header-anchor">#</a> Promise 错误</h2> <p><code>Promise</code>异常： <code>Promise</code> 被 <code>reject</code> 且没有被 <code>catch</code> 处理的时候，就会抛出 <code>Promise异常</code> （包括 <code>Promise</code> 内的 <code>JS</code> 错误）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">handler</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意：<code>promise</code> 报错只能获得具体报错信息，获取不到具体报错行号、列号</p> <h2 id="http-错误"><a href="#http-错误" class="header-anchor">#</a> HTTP 错误</h2> <p><code>HTTP</code> 异常：通常可以理解为是针对业务接口请求异常（400、500）或者是业务接口抛出的业务错误。</p> <p>从捕获角度来说，因为 <code>HTTP</code> 请求地层逻辑是基于 <code>XMLHttpRequest</code> | <code>fetch</code> 完成，因此可以重写方法来包含错误捕获逻辑</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">/* XMLHttpRequest 捕获指标 */</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">httpMetrics</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token constant">URL</span><span class="token punctuation">;</span>
  body<span class="token operator">:</span> Document <span class="token operator">|</span> XMLHttpRequestBodyInit <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">|</span> ReadableStream<span class="token punctuation">;</span>
  requestTime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  responseTime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  status<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  statusText<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  response<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>重写 <code>XMLHttpRequest</code></li></ul> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">proxyXmlHttp</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  sendHandler<span class="token operator">:</span> <span class="token builtin">Function</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  loadHandler<span class="token operator">:</span> <span class="token builtin">Function</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;XMLHttpRequest&quot;</span> <span class="token keyword">in</span> window <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">typeof</span> window<span class="token punctuation">.</span>XMLHttpRequest <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oXMLHttpRequest <span class="token operator">=</span> window<span class="token punctuation">.</span>XMLHttpRequest<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>window <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>oXMLHttpRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// oXMLHttpRequest 为原生的 XMLHttpRequest，可以用以 SDK 进行数据上报，区分业务</span>
      <span class="token punctuation">(</span>window <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>oXMLHttpRequest <span class="token operator">=</span> oXMLHttpRequest<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">(</span>window <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">XMLHttpRequest</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">oXMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> open<span class="token punctuation">,</span> send <span class="token punctuation">}</span> <span class="token operator">=</span> xhr<span class="token punctuation">;</span>
      <span class="token keyword">let</span> metrics <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> httpMetrics<span class="token punctuation">;</span>

      xhr<span class="token punctuation">.</span><span class="token function-variable function">open</span> <span class="token operator">=</span> <span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        metrics<span class="token punctuation">.</span>method <span class="token operator">=</span> method<span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span>
        <span class="token function">open</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      xhr<span class="token punctuation">.</span><span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        metrics<span class="token punctuation">.</span>body <span class="token operator">=</span> body <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span>requestTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// sendHandler 可以在发送 Ajax 请求之前，挂载一些信息，比如 header 请求头</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> sendHandler <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token function">sendHandler</span><span class="token punctuation">(</span>xhr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">send</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;loadend&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> status<span class="token punctuation">,</span> statusText<span class="token punctuation">,</span> response <span class="token punctuation">}</span> <span class="token operator">=</span> xhr<span class="token punctuation">;</span>
        metrics <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>metrics<span class="token punctuation">,</span>
          status<span class="token punctuation">,</span>
          statusText<span class="token punctuation">,</span>
          response<span class="token punctuation">,</span>
          responseTime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> loadHandler <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token function">loadHandler</span><span class="token punctuation">(</span>metrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// xhr.status 状态码</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> xhr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h2 id="跨域脚本错误"><a href="#跨域脚本错误" class="header-anchor">#</a> 跨域脚本错误</h2> <p>跨域脚本错误：存在跨域引用资源的情况</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">handler</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通过以上代码可以捕获这种类型错误，但是返回的永远是 <code>Script error</code>，也没有获取到<code>行号</code>、<code>列号</code>、<code>文件名</code>等的信息（其实这是浏览器的一个<code>安全机制</code>：当跨域加载的脚本中发生语法错误时，浏览器出于安全考虑，不会报告错误的细节，而只报告简单的 <code>Script error</code>。浏览器只允许同域下的脚本捕获具体错误信息，而其他脚本只知道发生了一个错误，但无法获知错误的具体内容（控制台仍然可以看到，JS 脚本无法捕获）</p> <ul><li><p>解决步骤</p> <ol><li><p>添加<code>crossorigin=&quot;anonymous&quot;</code>属性。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>script
  src<span class="token operator">=</span><span class="token string">&quot;http://crossorigin/texterror.js&quot;</span>
  crossorigin<span class="token operator">=</span><span class="token string">&quot;anonymous&quot;</span>
<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>静态资源所在服务器支持 <code>CORS</code></p></li></ol></li></ul> <h2 id="框架内错误"><a href="#框架内错误" class="header-anchor">#</a> 框架内错误</h2> <p>框架内错误捕获一般指的是在 Vue、React 框架内的错误捕获机制，为什么要独立开？框架内有自己的错误捕获机制.</p> <p><img alt="错误捕获.png" data-src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/363768b027f74831a7b65db6bbdbcd2b~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" loading="lazy" class="lazy"></p> <p>上图是 Vue 内部错误捕获的逻辑图，对一组件内抛出的异常其实 Vue 内部有对应的钩子函数对错误进行捕获的. 像一些运行时 JS 错误、异步 promise 错误 是能够被 handler 处理并执行我们定义的回调函数. 而不会被 window.onerror 或者 window.addEventListener('error') 捕获.</p> <blockquote><p>例外：第三方库内部的错误、setTimeout 错误、语法错误这些是没办法在框架内进行捕获</p></blockquote> <p>抽取错误捕获 sdk 的时候秉持的原则是尽量少改动代码，因此最好是不需要用户在 Vue.prototype.errorHandler 去添加额外代码，只需引入 sdk script 就好，那这时候就需要去重写捕获逻辑. Vue 如果不存在 errorHandler 的话最终会通过 console.error 输出错误，因此可以通过重写 console.error，在里面定义错误解析 &amp; 上报逻辑来简化使用成本. (<em>iframe 作为错误上报桥梁</em>)</p> <h1 id="前端错误上报"><a href="#前端错误上报" class="header-anchor">#</a> 前端错误上报</h1> <p>错误上报的过程涉及错误上报的方式 &amp; 时机.</p> <ul><li>错误上报的方式可以分为：beacon、image、request.</li> <li>上报时机不同项目的定义会有差异
<ul><li>比较常见的一种是在页面卸载前的适当时机进行上报（不阻塞主进程）</li> <li>在浏览器空闲的时候上报（requestIdleCallback）</li></ul></li></ul> <h2 id="beacon"><a href="#beacon" class="header-anchor">#</a> beacon</h2> <ul><li>适用场景：上报数据量少、在页面卸载前适当时机上报</li></ul> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">beacon</span><span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>？？？知识存疑</p></blockquote> <h2 id="image"><a href="#image" class="header-anchor">#</a> image</h2> <ul><li><p>优势</p> <ul><li>可以跨域发送请求</li> <li>不需要等待请求返回</li></ul></li> <li><p>缺点</p> <ul><li>url 有长度限制，数据太多会导致部分丢失</li></ul></li></ul> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">imgRequest</span><span class="token punctuation">(</span>data<span class="token operator">:</span> ReportData<span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">requestFun</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> spliceStr <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string">&quot;?&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">;</span>
    img<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>spliceStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">data=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>
      <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">addFn</span><span class="token punctuation">(</span>requestFun<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 上报队列</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="request"><a href="#request" class="header-anchor">#</a> request</h2> <ul><li>优势
<ul><li>没有数据长度、数据格式限制</li></ul></li> <li>缺点
<ul><li>需要配置跨域</li></ul></li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">xhrPost</span><span class="token punctuation">(</span>data<span class="token operator">:</span> ReportData<span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">requestFun</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      method<span class="token operator">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
      body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
      headers<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">addFn</span><span class="token punctuation">(</span>requestFun<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p>上报封装</p></blockquote> <p>上诉 image &amp; request 其实都用到了一个 addFn 函数 so why？其实上报并不是说错误发生了马上就上报的过程，就像上面说的有时机的控制. 那具体到 image &amp; request 的上报时机应该是在浏览器空闲时间或者是通过异步的方式从而避免阻塞主进程.</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Queue</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">addFn</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 收集需要上报的函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>requestIdleCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">flushFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">flushFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">flushFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 上报当前中的数据</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h1 id="前端错误定位"><a href="#前端错误定位" class="header-anchor">#</a> 前端错误定位</h1> <p>线上应用部署的过程：</p> <ul><li>构建工具从入口文件开始编译代码（Vue 模板编译）</li> <li>生成编译 chunk 文件（代码混淆）</li> <li>注入 html 引入</li></ul> <p>背景：引入 js 资源通常都是编译混淆好的 chunk 文件（script 资源明文传输导致源码暴露 &amp; 节省体积），因此通常错误抛出的文件都会显示为 [filename].[hash].js，没办法真正定位到 Vue / React 组件. 因此需要一个映射的过程，通过报错信息给出的错误文件、错误行号、错误列号定位到源代码的位置.</p> <p>解决：Sourcemap 维护了混淆后的代码行列到原代码行列的映射关系，根据混淆后的行列号，就能够获得对应的原始代码的行列号，结合源代码文件便可定位到真实的报错位置</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// soucemap 版本</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>

  <span class="token comment">// 转换后的文件名</span>

  <span class="token property">&quot;file&quot;</span><span class="token operator">:</span> <span class="token string">&quot;js/app.a2a3ceec.js&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// 转换前的文件所在目录，如果与转换前的文件在同一目录，该项为空</span>
  <span class="token property">&quot;sourceRoot&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>

  <span class="token comment">// 转换前的文件，该项是一个数组，表示可能存在多个文件合并</span>
  <span class="token property">&quot;sources&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;webpack://web-see-demo/./src/App.vue&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;webpack://web-see-demo/./src/main.js&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 转换前的所有变量名和属性名</span>
  <span class="token property">&quot;names&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

  <span class="token comment">// 原始文件内容</span>
  <span class="token property">&quot;sourcesContent&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;const add = (x,y) =&gt; {\n  return x+y;\n}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

  <span class="token comment">// 记录位置信息的字符串</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AAAA,IAAM,GAAG,GAAG,UAAC,CAAQ,EAAC,CAAQ;IAC5B,OAAO,CAAC,GAAC,CAAC,CAAC;AACb,CAAC,CAAA&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><blockquote><p>，mapping 采用可变长 VLQ 编码标识着源文件的信息 <a href="http://ruanyifeng.com/blog/2013/01/javascript_source_map.html" target="_blank" rel="noopener noreferrer">阮一峰<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <ul><li><p>第一位，表示这个位置在（转换后的代码的）的第几列。</p></li> <li><p>第二位，表示这个位置属于 sources 属性中的哪一个文件。</p></li> <li><p>第三位，表示这个位置属于转换前代码的第几行。</p></li> <li><p>第四位，表示这个位置属于转换前代码的第几列。</p></li> <li><p>第五位，表示这个位置属于 names 属性中的哪一个变量。</p></li></ul> <p><img src="capture.assets/image.png
" style="display:block;margin:auto;"></p> <h2 id="映射过程"><a href="#映射过程" class="header-anchor">#</a> 映射过程</h2> <p>npm 中有一些现成的库可以实现源码映射</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> sourceMap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'source-map'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'test.js.map'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">sourceMap<span class="token punctuation">.</span>SourceMapConsumer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

consumer<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> line <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">,</span> column <span class="token operator">=</span> <span class="token number">112003</span>
    <span class="token keyword">let</span> s <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">originPositionFor</span><span class="token punctuation">(</span><span class="token punctuation">{</span> line<span class="token punctuation">,</span> column <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
      c
       <span class="token punctuation">.</span><span class="token function">sourceContentFor</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>line <span class="token operator">-</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>line <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></div> <footer class="page-edit page-editor"><div class="edit-link"><a href="https://github.com/jzyismylover/ubuntu-markdown/edit/docs/fronted/monitor/errorCapture/capture.md" target="_blank" rel="noopener noreferrer">完善页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最近更新:</span> <span class="time">3/17/2024, 9:24:20 AM</span></div></footer> <div class="page-nav page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/markdown/electron-builder/" class="prev">
        electron-builder
      </a></span> <span class="next"><a href="/markdown/performance/">
        性能优化
      </a>
      →
    </span></p></div></div> <div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:86vh"><div style="font-weight:bold;">前端错误捕获</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/markdown/capture/#运行时错误" class="toc-sidebar-link">运行时错误</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/markdown/capture/#静态资源错误" class="toc-sidebar-link">静态资源错误</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/markdown/capture/#promise-错误" class="toc-sidebar-link">Promise 错误</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/markdown/capture/#http-错误" class="toc-sidebar-link">HTTP 错误</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/markdown/capture/#跨域脚本错误" class="toc-sidebar-link">跨域脚本错误</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/markdown/capture/#框架内错误" class="toc-sidebar-link">框架内错误</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/markdown/capture/#beacon" class="toc-sidebar-link">beacon</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/markdown/capture/#image" class="toc-sidebar-link">image</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/markdown/capture/#request" class="toc-sidebar-link">request</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/markdown/capture/#映射过程" class="toc-sidebar-link">映射过程</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div>  <div></div></main> <aside class="page-sidebar"> <div class="page-side-toolbar"></div>  </aside></div><div class="global-ui"><!----></div></div>
    <script src="/markdown/assets/js/app.085aa012.js" defer></script><script src="/markdown/assets/js/2.773263cd.js" defer></script><script src="/markdown/assets/js/42.19b2951c.js" defer></script>
  </body>
</html>
